<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QC Alert System</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">

<h1 class="text-2xl font-bold mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô QC</h1>

<form id="alertForm" class="bg-white p-4 rounded shadow-md space-y-4">
  <input type="text" id="title" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠" required class="w-full border px-2 py-1 rounded">
  <input type="text" id="category" placeholder="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó" required class="w-full border px-2 py-1 rounded">
  <input type="text" id="priority" placeholder="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç" required class="w-full border px-2 py-1 rounded">
  <input type="text" id="assignee" placeholder="‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö" required class="w-full border px-2 py-1 rounded">
  <textarea id="description" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" required class="w-full border px-2 py-1 rounded"></textarea>
  <input type="file" id="images" accept="image/*" multiple>
  <input type="file" id="files" multiple>
  <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
</form>

<h2 class="text-xl font-semibold mt-6 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h2>
<div id="alertsList" class="space-y-2"></div>

<script>
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbxHnehs-MNq-Iivid_6DeA7RNcvT4YxxO2SUpQG_W_yNH2UbhbrsJ6Ea8nDL6ynRQJ7/exec"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á Apps Script

let alerts = [];

// Convert file to Base64
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve({ name: file.name, base64: reader.result.split(',')[1], mimeType: file.type });
    reader.onerror = error => reject(error);
    reader.readAsDataURL(file);
  });
}

// Fetch alerts from sheet
function fetchAlerts() {
  fetch(SHEET_API_URL)
    .then(res => res.json())
    .then(data => {
      alerts = data.reverse();
      renderAlerts();
    });
}

// Render alerts
function renderAlerts() {
  const container = document.getElementById('alertsList');
  if(alerts.length===0){ container.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>"; return; }
  container.innerHTML = alerts.map(a => `
    <div class="bg-white p-3 rounded shadow">
      <div class="font-bold">${a.title}</div>
      <div>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${a.category} | ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö: ${a.assignee}</div>
      <div>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${a.description}</div>
      ${a.images.length>0 ? `<div>‡∏£‡∏π‡∏õ: ${JSON.parse(a.images).map(u=>`<a href="${u}" target="_blank">üì∑</a>`).join(" ")}</div>` : ""}
      ${a.files.length>0 ? `<div>‡πÑ‡∏ü‡∏•‡πå: ${JSON.parse(a.files).map(u=>`<a href="${u}" target="_blank">üìé</a>`).join(" ")}</div>` : ""}
    </div>
  `).join('');
}

// Handle form submit
document.getElementById('alertForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const imageFiles = Array.from(document.getElementById('images').files);
  const docFiles = Array.from(document.getElementById('files').files);
  const images = await Promise.all(imageFiles.map(f=>fileToBase64(f)));
  const files = await Promise.all(docFiles.map(f=>fileToBase64(f)));

  const newAlert = {
    id: Date.now(),
    title: document.getElementById('title').value,
    category: document.getElementById('category').value,
    priority: document.getElementById('priority').value,
    status: 'open',
    assignee: document.getElementById('assignee').value,
    description: document.getElementById('description').value,
    images, files
  };

  fetch(SHEET_API_URL, {
    method: 'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(newAlert)
  })
  .then(res=>res.json())
  .then(resp=>{
    if(resp.success){
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      this.reset();
      fetchAlerts();
    }
  });
});

// initial fetch
fetchAlerts();
</script>

</body>
</html>
